name: docker-multi-platform-earthly

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-amd64:
    name: Build and Push amd64 Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1

      - name: Build and Push amd64 Images with Earthly
        run: |
          earthly --ci --push --platform=linux/amd64 --TAG_SUFFIX=-amd64 +all

  build-arm64:
    name: Build and Push arm64 Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Setup Earthly
        uses: earthly/actions/setup-earthly@v1

      - name: Build and Push arm64 Images with Earthly
        run: |
          earthly --ci --push --platform=linux/arm64 --TAG_SUFFIX=-arm64 +all

  create-manifests:
    name: Create and Push Manifests
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and Push Manifests
        run: |
          RELEASE=$(cat release)
          DOCKER_REPO="ronkitay"
          IMAGES="basic-env duckdb mongo-client mysql-cli postgres-cli go-env jsqsh k8s-cli lua-5.4-env node-14-env node-16-env python-3-env rust-env vector eks"

          for img in $IMAGES; do
            echo "Creating manifest for $DOCKER_REPO/$img:$RELEASE"
            docker manifest create $DOCKER_REPO/$img:$RELEASE \
              --amend $DOCKER_REPO/$img:$RELEASE-amd64 \
              --amend $DOCKER_REPO/$img:$RELEASE-arm64
            docker manifest push $DOCKER_REPO/$img:$RELEASE
          done
